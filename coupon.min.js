/*!
 * project : coupon
 * author : LINOFFICE
 * 쿠폰함
 */ account||window.self.close();let enable_coupons=[],disable_coupons=[];function get_title(s){switch(s.itemId){case 0:return"NCOIN 쿠폰";case -1:return"NPOINT 쿠폰";default:return"아이템 쿠폰"}}function delete_modal(s){$("#ModalLayer").remove(),s&&location.reload()}function open_modal(s,a){$("#app").append('<div id="ModalLayer" class="modal_layer coupon_alert"><div class="dimmed_area"></div><div class="modal_wrap"><div class="content_wrapper"><div class="modal_content"><div class="content_area"><div class="box"><p>'+s+'</p></div></div></div><div class="modal_btn"><span class="btn_area apply"><button class="apply" onClick="delete_modal('+a+');"><span>확인</span></button></span></div></div></div></div>')}function open_modal_detail(s){let a=null;for(var o=0;o<enable_coupons.length;o++)if(enable_coupons[o].number==s){a=enable_coupons[o];break}if(!a)return;let e=a.expireTime,n='<div id="ModalLayer" class="modal_layer modalInfo coupon_modal"><div class="dimmed_area"></div><div class="modal_wrap" style="max-width: 440px;"><div class="wrap_box"><div class="box_content"><div class="modal_header"><h3>쿠폰정보</h3></div><button class="btn_close" onClick="delete_modal(false);"><span>닫기</span></button><div class="modal_scroll_wrap scrollbar-macosx"><div class="scroll_area"><div id="ModalCouponInfo" class="modal_coupon_info"><div class="modal_coupon_card lin"><div class="card_content"><span class="icon"></span><em class="c_tit">'+get_title(a)+'</em><span class="c_dsc">'+a.descrption+'</span></div><div class="card_sub"><span>'+moment(new Date(a.enableTime)).format("YYYY.MM.DD")+" ~ "+(e?moment(new Date(e)).format("YYYY.MM.DD"):"")+'</span></div></div><h3 class="sub_tit">혜택내용 : 상품지급</h3><div class="coupon_select_info"><div class="select_header"><span>선택 가능 수량 : <span class="count">전체</span></span></div><ul class="info_box lst_select"><li><span>'+a.descrption+'</span></li></ul></div></div></div></div><div class="modal_btn"><div id="ModalCouponBtn" class="modal_coupon_btn"><button type="button" class="btn delete"><span>삭제</span></button><div class="coupon_btn_area"><button type="button" class="btn" onClick="delete_modal(false); use_coupon_confirm(\''+s+"');\"><em>사용하기</em></button></div></div></div></div></div></div></div>";$("#app").append(n),$("#ModalLayer .scrollbar-macosx").scrollbar()}function close_form(){window.self.close()}$(function(){let s=$(".btn_close"),a=$(".coupon_list_wrap .coupon_count button"),o=$(".btn_register"),e=$(".list_coupon.present"),n=$(".list_msg"),l=$(".list_coupon.past"),c=$(".no_coupon"),i=account.coupons?account.coupons.length:0;if(i>0){let t="",p="";$.each(account.coupons,function(s,a){let o=a.expireTime;a.useTime?(disable_coupons.push(a),p+='<li><div class="coupon_info"><div class="coupon_info_content"><div class="flag lin"><span class="txt">리니지</span></div> <div class="info"><em class="tit">'+get_title(a)+'</em> <span class="sub">[리니지] '+a.descrption+'</span></div></div> <div class="stamp complete"><span class="v_align"><em>사용완료</em> <time>'+moment(new Date(a.useTime)).format("YYYY.MM.DD")+"</time></span></div></div></li>"):o&&getTime>=new Date(o).getTime()?(disable_coupons.push(a),p+='<li><div class="coupon_info"><div class="coupon_info_content"><div class="flag lin"><span class="txt">리니지</span></div> <div class="info"><em class="tit">'+get_title(a)+'</em> <span class="sub">[리니지] '+a.descrption+'</span></div></div> <div class="stamp expire"><span class="v_align"><em>기간만료</em> <time>'+moment(new Date(o)).format("YYYY.MM.DD")+"</time></span></div></div></li>"):(enable_coupons.push(a),t+='<li><div class="btn_area"><button class="btn" onClick="use_coupon_confirm(\''+a.number+'\');"><em>사용하기</em></button></div><div class="coupon_info"><div class="coupon_info_content"><div class="flag lin"><span class="txt">리니지</span></div> <div class="info"><em class="tit">'+get_title(a)+'</em> <span class="sub">[리니지] '+a.descrption+'</span></div><div class="time_area"><time>'+moment(new Date(a.enableTime)).format("YYYY.MM.DD")+"</time> ~ <time>"+(o?moment(new Date(o)).format("YYYY.MM.DD"):"")+'</time></div><button type="button" class="btn_detail" onClick="open_modal_detail(\''+a.number+"');\"><span>쿠폰 상세 정보</span></button></div></div></li>")}),e.html(t),l.html(p)}$(".coupon_list_wrap .coupon_count .num").text(enable_coupons.length),enable_coupons&&enable_coupons.length?e.css("display",""):c.css("display",""),s.on("click",function(s){close_form()}),a.on("click",function(s){let o=$(this);o.hasClass("on")||(a.removeClass("on"),o.addClass("on"),"과거이력"===o.children("span").text()?(e.css("display","none"),c.css("display","none"),n.css("display",""),l.css("display","")):(n.css("display","none"),l.css("display","none"),enable_coupons&&enable_coupons.length?e.css("display",""):c.css("display","")))}),o.on("click",function(s){regist_coupon()}),$(document).ready(function(){$(".scrollbar-macosx").scrollbar()})});var couponLock=!1;function regist_coupon(){if(couponLock)return;let s=$(".coupon_register input").val();if(!s){open_modal("쿠폰 번호를 입력해 주시기 바랍니다.",!1);return}if(12!=s.length){open_modal("쿠폰번호가 올바르지 않습니다.",!1);return}if(!account){open_modal("계정을 찾을 수 없습니다.",!1);return}couponLock=!0;let a={number:s.toUpperCase()};$.ajax({type:"post",datatype:"json",url:"/define/coupon/regist",data:a,success:function(s){switch(s){case 1:open_modal("정상적으로 등록되었습니다.",!0);break;case 2:open_modal("계정을 찾을 수 없습니다.",!1);break;case 3:open_modal("대표 캐릭터를 찾을 수 없습니다.",!1);break;case 4:open_modal("10회 이상 실패하여 24시간 등록 제한되었습니다.",!1);break;case 5:open_modal("일치하는 쿠폰번호가 없습니다.",!1);break;case 6:open_modal("이미 사용이 완료된 쿠폰입니다.",!1);break;case 7:open_modal("사용할 수 있는 기간이 아닙니다.",!1);break;case 8:open_modal("기간이 지난 쿠폰입니다.",!1);break;default:open_modal("등록에 실패하였습니다.",!1)}couponLock=!1},error:function(s,a,o){couponLock=!1}})}function use_coupon_confirm(s){if(!account){open_modal("계정을 찾을 수 없습니다.",!1);return}if(!account.ingame){open_modal("인게임에서 사용할 수 있습니다.",!1);return}popupShow("정말로 사용하시겠습니까?",'<span class="type2"><a href="javascript:use_coupon(\''+s+'\');" class="close">예</a></span>','<span class="type1"><a href="javascript:popupClose();" class="close">아니오</a></span>')}function use_coupon(s){if(couponLock)return;couponLock=!0;let a={number:s.toUpperCase()};$.ajax({type:"post",datatype:"json",url:"/define/coupon/use",data:a,success:function(s){switch(s){case 1:open_modal("쿠폰 사용이 완료되었습니다.",!0);break;case 2:open_modal("인게임에서 사용할 수 있습니다.",!1);break;case 3:open_modal("계정을 찾을 수 없습니다.",!1);break;case 4:open_modal("대표 캐릭터를 찾을 수 없습니다.",!1);break;case 5:open_modal("인게임 내 캐릭터를 찾을 수 없습니다.",!1);break;case 6:open_modal("일치하는 쿠폰번호가 없습니다.",!1);break;case 7:open_modal("이미 사용이 완료된 쿠폰입니다.",!1);break;case 8:open_modal("사용할 수 있는 기간이 아닙니다.",!1);break;case 9:open_modal("소유중인 쿠폰이 아닙니다.",!1);break;case 10:open_modal("디비 등록에 실패하였습니다.",!1);break;case 11:open_modal("부가서비스 창고에 아이템을 생성하지 못하였습니다.",!1);break;default:open_modal("등록에 실패하였습니다.",!1)}couponLock=!1},error:function(s,a,o){couponLock=!1}})}