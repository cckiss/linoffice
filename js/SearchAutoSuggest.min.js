/*!
 * project : SearchAutoSuggest
 * author : LINOFFICE
 * 검색 자동 제안
 */ class SearchAutoSuggest{constructor(t,e){if(!t||(this.option=t,this.parent=document.querySelector(this.option.selector),!this.parent))return;this.loadedKeyword="",this.dataBaseKeyword="",this.isValueFunctionText="",this.apiUrl="/define/suggest",this.suggestWrap=this.parent?.querySelector("[data-name='suggest_wrap']"),this.input=this.parent?.querySelector("[data-name='suggest_input']"),this.submitBtn=this.parent?.querySelector("[data-name='suggest_submit']"),this.deleteBtn=this.parent?.querySelector("[data-name='suggest_delete']"),this.resultUL=this.parent?.querySelector("[data-name='suggest_scroll'] ul"),this.suggestWrap&&(this.suggestWrap.style.display="none"),this.deleteBtn&&(this.deleteBtn.style.display="none"),(e=void 0===e||e)&&this.addEvents()}setInputValue(t){this.input&&(this.input.value=t)}getIndex(t){if(!t)return -1;let e=0;for(;t=t.previousElementSibling;)e++;return e}setDisplay(t,e){t&&(t.style.display=e?"block":"none")}load(t){this.loadedKeyword=t;fetch(`${this.apiUrl}?${new URLSearchParams({query:this.loadedKeyword?.replace(/\s*/g,""),page_size:this.option.size,type:this.option.type?this.option.type:"0"})}`,{method:"GET",credentials:"include"}).then(t=>t?.json()).then(t=>this.drawList(t)).catch(t=>console.log("::::::::::fail::::::::::",t))}addEvents(){let t=window.device&&"ingame"===window.device?"keypress":"keydown",e=[27,13,9,40,38];this.input?.addEventListener(t,t=>{let s=t.keyCode;if(e?.includes(s)){switch(s){case 27:this.setInputValue(this.loadedKeyword),this.suggestWrapToggle(!1);break;case 13:this.submitGo();break;case 9:this.focusChange(t.shiftKey?-1:1);break;case 40:this.focusChange(1);break;case 38:this.focusChange(-1)}return t.preventDefault(),!1}}),this.input?.addEventListener("focusout",t=>{setTimeout(()=>this.suggestWrapToggle(!1),150),this.sto&&(clearTimeout(this.sto),this.sto=null)});let s=this.resultUL?.querySelectorAll("li");this.input.addEventListener("focusin",t=>{this.isValueFunctionText="",this.sto||this.realTimeInputCheck(),s?.length&&this.suggestWrapToggle(!0)}),this.submitBtn?.addEventListener("click",t=>this.submitGo()),this.deleteBtn?.addEventListener("click",t=>{this.loadedKeyword="",this.setInputValue(""),this.input?.focus()}),this.listClickCallbackBind=this.listClickCallback.bind(this),this.listMouseOverCallbackBind=this.listMouseOverCallback.bind(this)}reset(){}realTimeInputCheck(){this.sto&&(clearTimeout(this.sto),this.sto=null);let t=this.input?.value,e=t?.trim();e?this.loadedKeyword!==e&&this.dataBaseKeyword!==e&&this.isValueFunctionText!==e&&(this.load(e),this.isValueFunctionText=""):(""!=this.loadedKeyword&&setTimeout(()=>{this.input?.value?.trim()||(this.loadedKeyword="")},10),this.resultUL?.hasChildNodes()&&setTimeout(()=>{this.resultUL.innerHTML="",this.suggestWrapToggle(!1)},10)),this.deleteBtnToggle(e),this.sto=setTimeout(()=>this.realTimeInputCheck(),10)}deleteBtnToggle(t=""){if(!this.option.useDelbtn)return!1;t?this.deleteBtnIsShow||(this.deleteBtn&&(this.deleteBtn.style.display="block"),this.deleteBtnIsShow=!0):this.deleteBtnIsShow&&(this.deleteBtn&&(this.deleteBtn.style.display="none"),this.deleteBtnIsShow=!1)}drawList(t){if(!t||!this.input?.value?.trim())return;let e=t;this.suggestWrapToggle(e.length>0),this.listRemoveEvent();let s="";if(e.length){let i=RegExp(this.loadedKeyword,"i");s=e.map((t,e)=>{let s=i.exec(t),l=t.replace(s,`<mark>${s}</mark>`);return`<li data-idx="${e}" data-keyword="${t}">${l}</li>`}).join("")}this.resultUL&&(this.resultUL.innerHTML=s),this.listAddEvent()}listRemoveEvent(){this.parent?.querySelectorAll("[data-name='suggest_scroll'] ul li")?.forEach(t=>{t?.removeEventListener("click",this.listClickCallbackBind),t?.removeEventListener("mouseover",this.listMouseOverCallbackBind)})}listAddEvent(){this.parent?.querySelectorAll("[data-name='suggest_scroll'] ul li")?.forEach(t=>{t?.addEventListener("click",this.listClickCallbackBind),t?.addEventListener("mouseover",this.listMouseOverCallbackBind)})}listClickCallback(t){let e=t?.currentTarget?.dataset?.keyword||"";this.setInputValue(e),this.submitGo()}listMouseOverCallback(t){let e=t.currentTarget,s=e?.parentElement,i=s?.querySelector("li.focus");i?.classList?.remove("focus"),e?.classList?.add("focus")}focusChange(t=1){let e=this.resultUL?.querySelectorAll("li"),s=e.length,i=this.resultUL?.querySelector(".focus"),l=this.getIndex(i)+(1===t?1:-1),a;a=e[l=l<0?s:l>s?0:l],i?.classList?.remove("focus"),this.suggestWrapToggle(!!a),a&&(a?.focus(),a?.classList?.add("focus"),this.dataBaseKeyword=a?.dataset?.keyword,this.setInputValue(this.dataBaseKeyword))}submitGo(){let t=this.input?.value?.trim();this.suggestWrapToggle(!1),""!==t&&(this.parent.action=this.option.action,this.parent.submit())}suggestWrapToggle(t=!0){this.setDisplay(this.suggestWrap,t),t||this.resultUL?.querySelectorAll("li")?.forEach(t=>t?.classList?.remove("focus"))}changeAddParam(t){this.option.addParam=t}value(t){this.isValueFunctionText=t,this.setInputValue(t)}}function create_auto_suggest(t){if(suggestEnable&&t)return new SearchAutoSuggest(t)}
