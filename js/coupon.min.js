/*!
 * project : coupon
 * author : LINOFFICE
 * 쿠폰함
 */ account||window.self.close();let coupon_singleton=null,coupon_singletonEnforcer="singletonEnforcer";class Coupon{constructor(e){if(e!==coupon_singletonEnforcer)throw"Cannot--construct singleton";this.init()}static get instance(){return coupon_singleton||(coupon_singleton=new Coupon(coupon_singletonEnforcer)),coupon_singleton}init(){let e=this;e.enable_coupons=[],e.disable_coupons=[],e.coupon_sync=!1,e.wrap_present=$(".list_coupon.present"),e.wrap_msg=$(".list_msg"),e.wrap_past=$(".list_coupon.past"),e.no_coupon=$(".no_coupon"),e.setInstance(),e.addEvents()}setInstance(){let e=this,s=account.coupons?account.coupons.length:0;if(s){let n="",a="";$.each(account.coupons,function(s,o){let t=o.expireTime;o.useTime?(e.disable_coupons.push(o),a+=`<li><div class="coupon_info"><div class="coupon_info_content"><div class="flag lin"><span class="txt">리니지</span></div> <div class="info"><em class="tit">${e.get_title(o)}</em> <span class="sub">[리니지] ${o.descrption}</span></div></div> <div class="stamp complete"><span class="v_align"><em>사용완료</em> <time>${moment(new Date(o.useTime)).format("YYYY.MM.DD")}</time></span></div></div></li>`):t&&getTime>=new Date(t).getTime()?(e.disable_coupons.push(o),a+=`<li><div class="coupon_info"><div class="coupon_info_content"><div class="flag lin"><span class="txt">리니지</span></div> <div class="info"><em class="tit">${e.get_title(o)}</em> <span class="sub">[리니지] ${o.descrption}</span></div></div> <div class="stamp expire"><span class="v_align"><em>기간만료</em> <time>${moment(new Date(t)).format("YYYY.MM.DD")}</time></span></div></div></li>`):(e.enable_coupons.push(o),n+=`<li><div class="btn_area"><button class="btn btn_use" data-id="${o.number}"><em>사용하기</em></button></div><div class="coupon_info"><div class="coupon_info_content"><div class="flag lin"><span class="txt">리니지</span></div> <div class="info"><em class="tit">${e.get_title(o)}</em> <span class="sub">[리니지] ${o.descrption}</span></div><div class="time_area"><time>${moment(new Date(o.enableTime)).format("YYYY.MM.DD")}</time> ~ <time>${t?moment(new Date(t)).format("YYYY.MM.DD"):""}</time></div><button type="button" class="btn_detail" data-id="${o.number}"><span>쿠폰 상세 정보</span></button></div></div></li>`)}),e.wrap_present.html(n),e.wrap_past.html(a),$(".list_coupon.present .btn_area .btn_detail").on("click",function(s){e.open_modal_detail($(this).attr("data-id"))}),$(".list_coupon.present .btn_area .btn_use").on("click",function(s){e.use_coupon_confirm($(this).attr("data-id"))})}$(".coupon_list_wrap .coupon_count .num").text(e.enable_coupons.length),e.enable_coupons.length?e.wrap_present.css("display",""):e.no_coupon.css("display","")}get_title(e){switch(e.itemId){case 0:return"NCOIN 쿠폰";case -1:return"NPOINT 쿠폰";default:return"아이템 쿠폰"}}regist_coupon(){let e=this;if(e.coupon_sync)return;let s=$(".coupon_register input").val();if(!s){e.open_modal("쿠폰 번호를 입력해 주시기 바랍니다.",!1);return}if(12!=s.length){e.open_modal("쿠폰번호가 올바르지 않습니다.",!1);return}if(!account){e.open_modal("계정을 찾을 수 없습니다.",!1);return}e.coupon_sync=!0;let n={number:s.toUpperCase()};getDatasWithOption([{type:"POST",url:"/define/coupon/regist",dataType:"json",contentType:"application/json",Accept:"application/json",data:n}],s=>{switch(s){case 1:e.open_modal("정상적으로 등록되었습니다.",!0);break;case 2:e.open_modal("계정을 찾을 수 없습니다.",!1);break;case 3:e.open_modal("대표 캐릭터를 찾을 수 없습니다.",!1);break;case 4:e.open_modal("10회 이상 실패하여 24시간 등록 제한되었습니다.",!1);break;case 5:e.open_modal("일치하는 쿠폰번호가 없습니다.",!1);break;case 6:e.open_modal("이미 사용이 완료된 쿠폰입니다.",!1);break;case 7:e.open_modal("사용할 수 있는 기간이 아닙니다.",!1);break;case 8:e.open_modal("기간이 지난 쿠폰입니다.",!1);break;default:e.open_modal("등록에 실패하였습니다.",!1)}e.coupon_sync=!1},s=>{e.coupon_sync=!1})}use_coupon_confirm(e){let s=this;if(!account){s.open_modal("계정을 찾을 수 없습니다.",!1);return}if(!account.ingame){s.open_modal("인게임에서 사용할 수 있습니다.",!1);return}popupShow("정말로 사용하시겠습니까?",`<span class="type2" id="use_coupon_btn"><a class="close">예</a></span>`,`<span class="type1"><a href="javascript:popupClose();" class="close">아니오</a></span>`),document.querySelector("#use_coupon_btn").addEventListener("click",n=>{s.use_coupon(e)})}use_coupon(e){let s=this;if(s.coupon_sync)return;s.coupon_sync=!0;let n={number:e.toUpperCase()};getDatasWithOption([{type:"POST",url:"/define/coupon/use",dataType:"json",contentType:"application/json",Accept:"application/json",data:n}],e=>{switch(e){case 1:s.open_modal("쿠폰 사용이 완료되었습니다.",!0);break;case 2:s.open_modal("인게임에서 사용할 수 있습니다.",!1);break;case 3:s.open_modal("계정을 찾을 수 없습니다.",!1);break;case 4:s.open_modal("대표 캐릭터를 찾을 수 없습니다.",!1);break;case 5:s.open_modal("인게임 내 캐릭터를 찾을 수 없습니다.",!1);break;case 6:s.open_modal("일치하는 쿠폰번호가 없습니다.",!1);break;case 7:s.open_modal("이미 사용이 완료된 쿠폰입니다.",!1);break;case 8:s.open_modal("사용할 수 있는 기간이 아닙니다.",!1);break;case 9:s.open_modal("소유중인 쿠폰이 아닙니다.",!1);break;case 10:s.open_modal("디비 등록에 실패하였습니다.",!1);break;case 11:s.open_modal("부가서비스 창고에 아이템을 생성하지 못하였습니다.",!1);break;default:s.open_modal("등록에 실패하였습니다.",!1)}s.coupon_sync=!1},e=>{s.coupon_sync=!1})}delete_modal(e){$("#ModalLayer").remove(),e&&location.reload()}open_modal(e,s){let n=this,a=`<div id="ModalLayer" class="modal_layer coupon_alert"><div class="dimmed_area"></div><div class="modal_wrap"><div class="content_wrapper"><div class="modal_content"><div class="content_area"><div class="box"><p>${e}</p></div></div></div><div class="modal_btn"><span class="btn_area apply"><button class="apply"><span>확인</span></button></span></div></div></div></div>`;$("#app").append(a),document.querySelector("#ModalLayer .btn_area.apply .apply").addEventListener("click",e=>{n.delete_modal(s)})}open_modal_detail(e){let s=this,n=null;for(var a=0;a<s.enable_coupons.length;a++)if(s.enable_coupons[a].number==e){n=s.enable_coupons[a];break}if(!n)return;let o=n.expireTime,t=`<div id="ModalLayer" class="modal_layer modalInfo coupon_modal"><div class="dimmed_area"></div><div class="modal_wrap" style="max-width: 440px;"><div class="wrap_box"><div class="box_content"><div class="modal_header"><h3>쿠폰정보</h3></div><button class="btn_close"><span>닫기</span></button><div class="modal_scroll_wrap scrollbar-macosx"><div class="scroll_area"><div id="ModalCouponInfo" class="modal_coupon_info"><div class="modal_coupon_card lin"><div class="card_content"><span class="icon"></span><em class="c_tit">${s.get_title(n)}</em><span class="c_dsc">${n.descrption}</span></div><div class="card_sub"><span>${moment(new Date(n.enableTime)).format("YYYY.MM.DD")} ~ ${o?moment(new Date(o)).format("YYYY.MM.DD"):""}</span></div></div><h3 class="sub_tit">혜택내용 : 상품지급</h3><div class="coupon_select_info"><div class="select_header"><span>선택 가능 수량 : <span class="count">전체</span></span></div><ul class="info_box lst_select"><li><span>${n.descrption}</span></li></ul></div></div></div></div><div class="modal_btn"><div id="ModalCouponBtn" class="modal_coupon_btn"><button type="button" class="btn delete"><span>삭제</span></button><div class="coupon_btn_area"><button type="button" class="btn use"><em>사용하기</em></button></div></div></div></div></div></div></div>`;$("#app").append(t),document.querySelector("#ModalLayer .btn_close").addEventListener("click",e=>{s.delete_modal(!1)}),document.querySelector("#ModalLayer .coupon_btn_area .btn.use").addEventListener("click",n=>{s.delete_modal(!1),s.use_coupon_confirm(e)}),$("#ModalLayer .scrollbar-macosx").scrollbar()}addEvents(){let e=this;e.btn_tabs=$(".coupon_list_wrap .coupon_count button"),e.btn_tabs.on("click",function(s){let n=$(this);n.hasClass("on")||(e.btn_tabs.removeClass("on"),n.addClass("on"),"과거이력"===n.children("span").text()?(e.wrap_present.css("display","none"),e.no_coupon.css("display","none"),e.wrap_msg.css("display",""),e.wrap_past.css("display","")):(e.wrap_msg.css("display","none"),e.wrap_past.css("display","none"),e.enable_coupons.length?e.wrap_present.css("display",""):e.no_coupon.css("display","")))}),document.querySelector(".coupon_register .input_area .btn_register").addEventListener("click",s=>{e.regist_coupon()}),document.querySelector(".wrap header .btn_close").addEventListener("click",e=>{window.self.close()}),$(".scrollbar-macosx").scrollbar()}}Coupon.instance;
