/*!
 * project : websocket
 * author : LINOFFICE
 * 웹소켓
 */ let ws_handler;class WebSocketHandler{ws=null;url=null;constructor(e){if(!e||ws_handler)return!1;this.url="ingame"===device?e.ingame_url:e.url}connect(){if(!this.url){popupShow("웹소켓 서버 비활성화 상태입니다.",'<span class="type2"><a href="javascript:popupClose();" class="close">닫기</a></span>',null);return}if(this.is_open()){popupShow("웹소켓이 이미 활성화 되어 있습니다. STATE : "+this.ws.readyState,'<span class="type2"><a href="javascript:popupClose();" class="close">닫기</a></span>',null);return}this.ws=new WebSocket(this.url),this.ws.onopen=e=>{on_open(e)},this.ws.onmessage=e=>{on_message(e)},this.ws.onclose=e=>{on_close(e)},this.ws.onerror=e=>{on_error(e)}}close(){this.ws&&(this.ws.close(),this.ws=null)}is_connecting(){return this.ws&&this.ws.readyState==WebSocket.CONNECTING}is_open(){return this.ws&&this.ws.readyState==WebSocket.OPEN}is_closing(){return this.ws&&this.ws.readyState==WebSocket.CLOSING}is_closed(){return this.ws&&this.ws.readyState==WebSocket.CLOSED}send(e,t){this.is_open()&&this.ws.send(e+JSON.stringify(t))}}const on_open=e=>{"CHAT"===tabType&&chat_render("서버와 연결되었습니다.")},on_message=e=>{let t=e.data;if(-1==t.indexOf("{")){console.log("not found protocol delimiter "+t);return}var r=JSON.parse(t);if(!r){console.log("not found protocol object "+t);return}if(r.type==tabType)switch(r.type){case"PERFORM":perform_rendar(r);break;case"SUPPORT":case"REPORT":user_noti(r.message);break;case"CHAT":chat_render(r.message);break;default:console.log("not found protocol type "+r.type)}},on_close=e=>{"CHAT"===tabType&&chat_render("서버와 연결이 종료되었습니다.")},on_error=e=>{console.log(e)};function perform_run(){ws_handler.send("PERFORM",{is_enable:!0})}function perform_stop(){ws_handler.send("PERFORM",{is_enable:!1})}function perform_rendar(e){var t=e.cpu_usage,r="";r=t>50?"서버의 cpu 사용량이 높습니다. 점검이 필요합니다.":t>30?"서버의 cpu가 불안정합니다.":"안정적으로 가동 중입니다.",$(".cpu .graph-text-view .var").html("사용 중인 CPU:"+t+"%"),$(".cpu .percent-wrap .bar").css("width",t+"%"),$(".cpu .percent-wrap .info-tooltip span").html(r);var c=calculatePercent(e.used_memory,e.max_memory),a="";a=c>80?"메모리 사용량이 너무 높습니다. 점검이 필요합니다.":c>70?"메모리 사용량이 높습니다. 주시가 필요합니다.":c>60?"메모리 사용량이 높은 편입니다.":c>50?"메모리 사용량이 불안정합니다.":"안정적으로 가동 중입니다.",$(".memory .graph-text-view .var").html("사용 중인 메모리:"+c+"% ("+parseInt(e.used_memory/1024)+"mb / "+e.used_memory+"kb)"),$(".memory .percent-wrap .bar").css("width",c+"%"),$(".memory .percent-wrap .info-tooltip span").html(a);var s=calculatePercent(e.thread_count,1e3),n="";n=e.thread_count>900?"전체 스레드 할당량이 너무 높습니다. 점검이 필요합니다.":e.thread_count>800?"전체 스레드 할당량이 높은 편입니다. 점검이 필요합니다.":e.thread_count>700?"전체 스레드 할당량이 불안정합니다.":"안정적으로 가동 중입니다.",$(".thread-total .graph-text-view .var").html("전체 스레드 할당량:"+s+"% ("+e.thread_count+")"),$(".thread-total .percent-wrap .bar").css("width",s+"%"),$(".thread-total .percent-wrap .info-tooltip span").html(n);var l=calculatePercent(e.executor.active,e.executor.poolSize),o="";o=l>70?"excutor 스레드 풀 활성량이 너무 높습니다. 풀 크기 재점검이 필요합니다.":l<10?"excutor 스레드 풀 활성량이 너무 낮습니다. 풀 크기 재점검이 필요합니다.":"excutor 스레드 풀이 안정적입니다.",$(".thread-executor .graph-text-view .var").html("일반 스레드 풀 사용량:"+l+"% (활성:"+e.executor.active+", 풀크기:"+e.executor.poolSize+", 대기중:"+e.executor.queue+", 완료:"+e.executor.complete+", 총합:"+e.executor.task+")"),$(".thread-executor .percent-wrap .bar").css("width",l+"%"),$(".thread-executor .percent-wrap .info-tooltip span").html(o);var p=calculatePercent(e.scheduler.active,e.scheduler.poolSize),i="";i=p>70?"scheduler 스레드 풀 활성량이 너무 높습니다. 풀 크기 재점검이 필요합니다.":p<10?"scheduler 스레드 풀 활성량이 너무 낮습니다. 풀 크기 재점검이 필요합니다.":"scheduler 스레드 풀이 안정적입니다.",$(".thread-scheduler .graph-text-view .var").html("스케줄 스레드 풀 사용량:"+p+"% (활성:"+e.scheduler.active+", 풀크기:"+e.scheduler.poolSize+", 대기중:"+e.scheduler.queue+", 완료:"+e.scheduler.complete+", 총합:"+e.scheduler.task+")"),$(".thread-scheduler .percent-wrap .bar").css("width",p+"%"),$(".thread-scheduler .percent-wrap .info-tooltip span").html(i);var h=calculatePercent(e.pcScheduler.active,e.pcScheduler.poolSize),u="";u=h>70?"pc_scheduler 스레드 풀 활성량이 너무 높습니다. 풀 크기 재점검이 필요합니다.":h<10?"pc_scheduler 스레드 풀 활성량이 너무 낮습니다. 풀 크기 재점검이 필요합니다.":"pc_scheduler 스레드 풀이 안정적입니다.",$(".thread-pc-scheduler .graph-text-view .var").html("PC스케줄 스레드 풀 사용량:"+h+"% (활성:"+e.pcScheduler.active+", 풀크기:"+e.pcScheduler.poolSize+", 대기중:"+e.pcScheduler.queue+", 완료:"+e.pcScheduler.complete+", 총합:"+e.pcScheduler.task+")"),$(".thread-pc-scheduler .percent-wrap .bar").css("width",h+"%"),$(".thread-pc-scheduler .percent-wrap .info-tooltip span").html(u);var d=calculatePercent(e.clients,e.clientsLimit),m="";m=d>80?"접속량이 높습니다. 공격을 의심하거나, 최대 접속량을 확인하세요.":"안정적으로 가동중입니다.",$(".clients .graph-text-view .var").html("접속률:"+d+"% (활성 클라이언트 수:"+e.clients+", 최대 접속 가능:"+e.clientsLimit+")"),$(".clients .percent-wrap .bar").css("width",d+"%"),$(".clients .percent-wrap .info-tooltip span").html(m);var w=calculatePercent(e.npcs,1e4),f="";f=w>80?"npc 수가 너무 많습니다. npc를 줄이거나 npc누수가 있는지 확인해주세요.":w>70?"npc 수가 높은 편입니다. 관리가 필요합니다.":w>50?"npc 수를 조절하여 더 최적화 할 수 있습니다.":"npc 수가 안정적입니다.",$(".npcs .graph-text-view .var").html("npc 스폰률:"+w+"% (활성 npc 수:"+e.npcs+")"),$(".npcs .percent-wrap .bar").css("width",w+"%"),$(".npcs .percent-wrap .info-tooltip span").html(f);var v=calculatePercent(e.items,1e4),g="";g=v>80?"활성 아이템 수가 너무 많습니다. 아이템 수를 줄이거나 아이템 누수가 있는지 확인해주세요.":v>70?"활성 아이템 수가 높은 편입니다. 관리가 필요합니다.":v>50?"활성 아이템 수를 조절하여 더 최적화 할 수 있습니다.":"활성 아이템 수가 안정적입니다.",$(".items .graph-text-view .var").html("item 할당률:"+v+"% (활성 item 수:"+e.items+")"),$(".items .percent-wrap .bar").css("width",v+"%"),$(".items .percent-wrap .info-tooltip span").html(g)}function calculatePercent(e,t){return e<=0?0:Math.max(Math.min(parseInt(e/t*100),100),0)}function user_noti(e){popupShow(e,'<span class="type2"><a href="javascript:popupClose();" class="close">닫기</a></span>',null)}function chat_run(){let e=$("#chat_param").val();if(e)$("#chat_param").val(""),ws_handler&&account&&account.firstChar&&account.firstChar.gm&&ws_handler.send("CHAT",{name:account.firstChar.name,message:e,to:$("#chat_to").val()})}function chat_render(e){if(!e)return;let t=$("#chat_result_box ul");t.prop("scrollHeight")>1e4&&t.text(""),t.append("<li>"+e+"</li>"),t.scrollTop(t.prop("scrollHeight"))}(ws_handler=new WebSocketHandler(ws_config)).connect();